pipeline {
    agent any

    environment {
        GCP_PROJECT = 'm-amr-project-one'
        ARTIFACT_REGISTRY_REPO = 'us-central1-docker.pkg.dev/m-amr-project-one/cluster-storage/'
        DOCKER_IMAGE_NAME = 'helloworld-flask-app'
        SERVICE_ACCOUNT_JSON_KEY = credentials('gcp-service-account-key0')
    }

    stages {
        stage('Importing the application') {
            steps {
                script {
                    // Clone the repo
                    git branch: 'main',
                    url: 'https://github.com/mohamedamr99t/FINAL-PROJECT-ITI'
                }
            }
        }

        stage('Building the image into the ARTIFACT REGISTRY') {
            steps {
                script {
                    sh "gcloud auth activate-service-account --key-file=${SERVICE_ACCOUNT_JSON_KEY}"
                    sh "gcloud config set project ${GCP_PROJECT}"
                    // SSH into the management instance
                    gcloud compute ssh --zone "us-central1-b" "vmmanagement" --tunnel-through-iap --project "m-amr-project-one"
                    dir('application/') {
                        // Build and push the Docker image to Google Artifact Registry
                        sh "docker build -t $ARTIFACT_REGISTRY_REPO/$DOCKER_IMAGE_NAME ."
                        sh "gcloud auth configure-docker us-central1-docker.pkg.dev"
                        sh "docker push $ARTIFACT_REGISTRY_REPO/$DOCKER_IMAGE_NAME"
                    }
                }
            }
        }

        stage('Deploying the image into the gke cluster') {
            steps {
                script {
                    sh "gcloud auth activate-service-account --key-file=${SERVICE_ACCOUNT_JSON_KEY}"
                    sh "gcloud config set project ${GCP_PROJECT}"
                    // SSH into the GCE instance
                    gcloud compute ssh --zone "us-central1-b" "vmmanagement" --tunnel-through-iap --project "m-amr-project-one"
                    // Configure kubectl to use the GKE cluster
                    sh "gcloud container clusters get-credentials my-cluster --region asia-east1 --project m-amr-project-one"
                    // Apply the Kubernetes Deployment YAML
                    dir('application/') {
                        sh "kubectl apply -f application_deployment.yaml"
                    }
                }
            }
        }
    }
}
